<script>
  // helper: parse fragment or query-string into object
  function parseParams(raw) {
    if (!raw) return {};
    raw = raw.replace(/^[#?]/, '');
    return raw.split('&').reduce((acc, pair) => {
      if (!pair) return acc;
      const [k, v=''] = pair.split('=');
      try { acc[decodeURIComponent(k)] = decodeURIComponent(v); } catch(e){ acc[k]=v; }
      return acc;
    }, {});
  }

  // 1) If URL has ?redirect=ENCODED_CONFIRMATION_URL, follow it (this gets the fragment)
  const qs = new URLSearchParams(window.location.search);
  const redirectParam = qs.get('redirect') || qs.get('redirect_to');
  if (redirectParam) {
    // redirectParam might be encoded (and may contain a fragment)
    const target = decodeURIComponent(redirectParam);
    // If target already contains a fragment like '#access_token=' just navigate to it.
    window.location.href = target;
    // stop further processing
  } else {
    // 2) parse fragment and search for access_token
    const fragParams = parseParams(window.location.hash);
    const searchParams = parseParams(window.location.search);
    const params = Object.assign({}, searchParams, fragParams);

    // UI refs
    const pwForm = document.getElementById('pwForm');
    const noToken = document.getElementById('noToken');
    const alertInfo = document.getElementById('alertInfo');
    const alertError = document.getElementById('alertError');

    // show error if present
    if (params.error || params.error_code) {
      const code = params.error_code || params.error || '';
      const desc = params.error_description || '';
      alertError.style.display = 'block';
      alertError.textContent = 'Reset link issue: ' + code + (desc ? ' — ' + desc : '');
      noToken.style.display = 'block';
    } else if (params.access_token) {
      // good — token present
      pwForm.style.display = 'block';
      alertInfo.style.display = 'block';
      alertInfo.textContent = 'Secure session detected. Enter a new password.';

      const btnReset = document.getElementById('btnReset');
      btnReset.addEventListener('click', async () => {
        const pw = (document.getElementById('pw')||{}).value || '';
        const pw2 = (document.getElementById('pw2')||{}).value || '';
        if (!pw || pw.length < 6) { alertError.style.display='block'; alertError.textContent='Password must be at least 6 characters'; return; }
        if (pw !== pw2) { alertError.style.display='block'; alertError.textContent='Passwords do not match'; return; }

        btnReset.disabled = true;
        btnReset.textContent = 'Updating...';

        try {
          const SUPABASE_URL = "https://zholdpdpceyaltagfnlr.supabase.co";
          const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY_HERE"; // set before deploy or inject via env

          const resp = await fetch(SUPABASE_URL + '/auth/v1/user', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + params.access_token,
              'apikey': SUPABASE_ANON_KEY
            },
            body: JSON.stringify({ password: pw })
          });
          const txt = await resp.text();
          if (resp.ok) {
            document.getElementById('alertSuccess').style.display = 'block';
            document.getElementById('alertSuccess').textContent = 'Password updated. You can now sign in.';
            // clear fragment so token isn't reused
            history.replaceState({}, '', window.location.pathname);
          } else {
            document.getElementById('alertError').style.display='block';
            try {
              const j = JSON.parse(txt);
              document.getElementById('alertError').textContent = j.error || j.message || txt;
            } catch(e) { document.getElementById('alertError').textContent = txt || 'Failed to update password'; }
          }
        } catch (e) {
          document.getElementById('alertError').style.display='block';
          document.getElementById('alertError').textContent = 'Network error: ' + e.message;
        } finally {
          btnReset.disabled = false;
          btnReset.textContent = 'Set password';
        }
      });
    } else {
      // no token found
      noToken.style.display = 'block';
      alertInfo.style.display = 'block';
      alertInfo.textContent = 'If you reached this page from an email, the link may have expired. Request a new reset from the app.';
    }
  }
</script>
